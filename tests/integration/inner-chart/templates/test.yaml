apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-comm-test
  annotations:
    "helm.sh/hook": test
  labels:
    helm.sh/hook: test
    app.kubernetes.io/instance: {{ .Release.Name }}
spec:
  automountServiceAccountToken: false
  restartPolicy: Never
  containers:
    - name: test
      image: docker.io/rancher/mirrored-library-busybox:1.36.1
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║         SERVICE COMMUNICATION TEST                           ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # Wait for server pod to be ready
          echo "Waiting for HTTP server service..."
          for i in $(seq 1 30); do
            if wget -q -O /tmp/response http://{{ .Release.Name }}-http-svc:80/ 2>/dev/null; then
              echo "✅ Server is reachable!"
              break
            fi
            echo "  Waiting for service... ($i/30)"
            sleep 2
          done
          
          if [ ! -f /tmp/response ]; then
            echo "❌ Failed to reach server via service!"
            echo "Debug: DNS lookup result:"
            nslookup {{ .Release.Name }}-http-svc 2>&1 || echo "(nslookup not available)"
            exit 1
          fi
          
          RESPONSE=$(cat /tmp/response)
          echo ""
          echo "Response from server: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "HELLO FROM NESTED K3S SERVER"; then
            echo ""
            echo "✅ SERVICE COMMUNICATION TEST PASSED!"
            echo "   Pod → Service → Pod networking works!"
            exit 0
          else
            echo ""
            echo "❌ Unexpected response from server"
            exit 1
          fi
