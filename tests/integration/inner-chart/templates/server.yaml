apiVersion: v1
kind: Pod
metadata:
  name: {{ .Release.Name }}-http-server
  labels:
    app: http-server
spec:
  automountServiceAccountToken: false
  restartPolicy: Never
  containers:
    - name: server
      image: docker.io/rancher/mirrored-library-busybox:1.36.1
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Starting HTTP server on port 8080..."
          mkdir -p /www
          echo "HELLO FROM NESTED K3S SERVER" > /www/index.html
          httpd -f -p 8080 -h /www
      ports:
        - containerPort: 8080
      readinessProbe:
        httpGet:
          path: /
          port: 8080
        initialDelaySeconds: 2
        periodSeconds: 2
---
apiVersion: v1
kind: Service
metadata:
  name: {{ .Release.Name }}-http-svc
spec:
  selector:
    app: http-server
  ports:
    - port: 80
      targetPort: 8080
