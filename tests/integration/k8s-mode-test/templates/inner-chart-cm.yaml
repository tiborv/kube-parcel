apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-inner-chart
data:
  Chart.yaml: |
    apiVersion: v2
    name: inner-chart
    description: Inner chart for testing nested K3s connectivity
    version: 0.1.0
  server.yaml: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: {{ "{{" }} .Release.Name {{ "}}" }}-http-server
      labels:
        app: http-server
    spec:
      automountServiceAccountToken: false
      restartPolicy: Never
      containers:
        - name: server
          image: docker.io/rancher/mirrored-library-busybox:1.36.1
          imagePullPolicy: Never
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "Starting HTTP server on port 8080..."
              mkdir -p /www
              echo "HELLO FROM NESTED K3S SERVER" > /www/index.html
              httpd -f -p 8080 -h /www
          ports:
            - containerPort: 8080
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 2
            periodSeconds: 2
    ---
    apiVersion: v1
    kind: Service
    metadata:
      name: {{ "{{" }} .Release.Name {{ "}}" }}-http-svc
    spec:
      selector:
        app: http-server
      ports:
        - port: 80
          targetPort: 8080
  test.yaml: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: {{ "{{" }} .Release.Name {{ "}}" }}-comm-test
      annotations:
        "helm.sh/hook": test
      labels:
        helm.sh/hook: test
        app.kubernetes.io/instance: {{ "{{" }} .Release.Name {{ "}}" }}
    spec:
      automountServiceAccountToken: false
      restartPolicy: Never
      containers:
        - name: test
          image: docker.io/rancher/mirrored-library-busybox:1.36.1
          imagePullPolicy: Never
          command: ["/bin/sh", "-c"]
          args:
            - |
              echo "╔══════════════════════════════════════════════════════════════╗"
              echo "║         SERVICE COMMUNICATION TEST                           ║"
              echo "╚══════════════════════════════════════════════════════════════╝"
              echo ""
              
              # Wait for server pod to be ready
              echo "Waiting for HTTP server service..."
              for i in $(seq 1 30); do
                if wget -q -O /tmp/response http://{{ "{{" }} .Release.Name {{ "}}" }}-http-svc:80/ 2>/dev/null; then
                  echo "✅ Server is reachable!"
                  break
                fi
                echo "  Waiting for service... ($i/30)"
                sleep 2
              done
              
              if [ ! -f /tmp/response ]; then
                echo "❌ Failed to reach server via service!"
                echo "Debug: DNS lookup result:"
                nslookup {{ "{{" }} .Release.Name {{ "}}" }}-http-svc 2>&1 || echo "(nslookup not available)"
                exit 1
              fi
              
              RESPONSE=$(cat /tmp/response)
              echo ""
              echo "Response from server: $RESPONSE"
              
              if echo "$RESPONSE" | grep -q "HELLO FROM NESTED K3S SERVER"; then
                echo ""
                echo "✅ SERVICE COMMUNICATION TEST PASSED!"
                echo "   Pod → Service → Pod networking works!"
                exit 0
              else
                echo ""
                echo "❌ Unexpected response from server"
                exit 1
              fi
